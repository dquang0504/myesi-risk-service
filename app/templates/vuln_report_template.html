<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ project_name }} - Vulnerability Report</title>
  <style>
    body { font-family: Arial, sans-serif; color: #222; margin: 40px; }
    h1, h2, h3 { color: #1a1a1a; }
    .summary { margin-bottom: 25px; }
    .chart { text-align: center; margin: 20px 0; }
    .severity-critical { color: #d7191c; }
    .severity-high { color: #e6550d; }
    .severity-medium { color: #fdae6b; }
    .severity-low { color: #fee6ce; }
    .issue { border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px; }
    .meta { font-size: 12px; color: #555; }
    .references { font-size: 12px; color: #007bff; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f7f7f7; }
  </style>
</head>
<body>
  <h1>Vulnerability Report</h1>
  <p><b>Project:</b> {{ project_name }}</p>
  <p><b>Generated by:</b> User ID {{ user_id }} on {{ generated }}</p>

  <div class="summary">
    <h2>Summary</h2>
    <p><b>Total Vulnerabilities:</b> {{ total_vulns }}</p>
    <p><b>Average Risk Score:</b> {{ avg_risk }}</p>

    <table>
      <tr><th>Severity</th><th>Count</th></tr>
      {% for sev, count in sev_counts.items() %}
        <tr><td style="color: {{ '#d7191c' if sev=='critical' else '#e6550d' if sev=='high' else '#fdae6b' if sev=='medium' else '#fee6ce' }}">{{ sev|capitalize }}</td><td>{{ count }}</td></tr>
      {% endfor %}
    </table>

    <div class="chart">
      <img src="data:image/png;base64,{{ chart_b64 }}" alt="Severity Chart">
    </div>
  </div>

  <h2>Detailed Findings</h2>
  {% for i in issues %}
  <div class="issue">
    <h3 class="severity-{{ i.severity|lower }}">{{ i.title }}</h3>
    <p><b>Severity:</b> {{ i.severity }} | <b>Component:</b> {{ i.component }}@{{ i.version }}</p>
    <p><b>CVSS:</b> {{ i.cvss or 'N/A' }} | <b>Risk Score:</b> {{ i.risk_score or 'N/A' }}</p>
    <p>{{ i.description }}</p>
    <p><b>Remediation:</b> {{ i.fix }}</p>
    {% if i.references %}
      <div class="references">
        References:
        {% for ref in i.references %}
          <a href="{{ ref }}" target="_blank">{{ ref }}</a>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
  {% endfor %}

  <hr>
  <p style="font-size: 11px;">Generated by MyESI Platform â€” {{ generated }}</p>
</body>
</html>
